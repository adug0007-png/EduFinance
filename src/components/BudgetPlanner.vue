<template>
  <div class="budget-planner">
    <div class="main-content">
      <div class="container">
        <!-- 左侧表单 + 右侧 Flashcards -->
        <div class="budget-section">
          <!-- 左侧：预算表单 -->
          <div class="form-section">
            <!-- 收入 -->
            <div class="income-section">
              <div class="section-header">
                <div class="section-icon green"></div>
                <h3>Monthly Income</h3>
              </div>
              <div class="form-group">
                <label>Salary</label>
                <input type="text" v-model="income.salary" placeholder="Enter your monthly salary" />
              </div>
              <div class="form-group">
                <label>Investments</label>
                <input type="text" v-model="income.investments" placeholder="Investment returns" />
              </div>
              <div class="form-group">
                <label>Other Income</label>
                <input type="text" v-model="income.other" placeholder="Freelance, side jobs, etc." />
              </div>
            </div>

            <!-- 支出 -->
            <div class="expenses-section">
              <div class="section-header">
                <div class="section-icon red"></div>
                <h3>Monthly Expenses</h3>
              </div>
              <div class="form-group">
                <label>Housing</label>
                <input type="text" v-model="expenses.housing" placeholder="Rent, mortgage, utilities" />
              </div>
              <div class="form-group">
                <label>Transportation</label>
                <input type="text" v-model="expenses.transportation" placeholder="Car payments, gas, public transport" />
              </div>
              <div class="form-group">
                <label>Food & Dining</label>
                <input type="text" v-model="expenses.food" placeholder="Groceries, restaurants" />
              </div>
              <div class="form-group">
                <label>Entertainment</label>
                <input type="text" v-model="expenses.entertainment" placeholder="Movies, subscriptions, hobbies" />
              </div>
              <div class="form-group">
                <label>Healthcare</label>
                <input type="text" v-model="expenses.healthcare" placeholder="Insurance, medical expenses" />
              </div>
            </div>

            <button class="calculate-btn" @click="calculateBudget">Calculate Budget</button>
          </div>

          <!-- 右侧：Flashcards（图表 <-> Alerts） -->
          <div class="summary-section">
            <div class="flashcard">
              <div class="flashcard-header">
                <h3>{{ activeIndex === 0 ? 'Expense Distribution' : 'Overspending Alerts' }}</h3>
                <div class="nav">
                  <button class="nav-btn" @click="prevCard" aria-label="Previous">‹</button>
                  <button class="nav-btn" @click="nextCard" aria-label="Next">›</button>
                </div>
              </div>

              <!-- v-show：不销毁 DOM，ECharts 实例不会丢 -->
              <div class="flashcard-body">
                <!-- 卡片 1：支出分布（饼图） -->
                <div v-show="activeIndex === 0" class="pane">
                  <div class="chart-section">
                    <div ref="chartRef" class="chart-container"></div>
                  </div>
                </div>

                <!-- 卡片 2：Overspending Alerts（Spent 取左侧输入；Budget 可编辑） -->
                <div v-show="activeIndex === 1" class="pane">
                  <div class="alerts-intro">
                    <p class="muted">Real-time monitoring of your spending patterns</p>
                  </div>
                  <div class="alerts-grid compact">
                    <div
                      v-for="item in alertCards"
                      :key="item.key"
                      class="alert-card"
                      :class="statusClass(item)"
                    >
                      <div class="alert-header">
                        <h4>{{ item.name }}</h4>
                        <div class="alert-icon">{{ statusIcon(item) }}</div>
                      </div>

                      <div class="alert-content">
                        <div class="alert-row">
                          <span>Spent</span>
                          <span>${{ formatNumber(item.spent) }}</span>
                        </div>

                        <div class="alert-row editable">
                          <span>Budget</span>
                          <div class="budget-edit">
                            <span class="currency">$</span>
                            <input
                              type="number"
                              class="budget-input"
                              v-model.number="budgets[item.key]"
                              min="0"
                            />
                          </div>
                        </div>

                        <div class="progress-bar">
                          <div
                            class="progress-fill"
                            :class="barClass(item)"
                            :style="{ width: progressWidth(item) }"
                          ></div>
                        </div>
                        <div class="alert-status">
                          {{ percentUsed(item) }}% - {{ statusText(item) }}
                        </div>
                      </div>
                    </div>
                  </div>
                </div> <!-- /pane -->
              </div> <!-- /flashcard-body -->
            </div>
          </div>
        </div>

        <!-- 储蓄目标计算器（保留原风格） -->
        <div class="savings-calculator-section">
          <div class="calc-header">
            <h2>Savings Goal Calculator</h2>
            <p>Set your financial goals and discover how much you need to save</p>
          </div>
          <div class="calculator-card">
            <div class="calculator-container">
              <!-- 左：表单 -->
              <div class="calculator-left">
                <div class="form-section">
                  <div class="form-group">
                    <label>Savings Goal</label>
                    <input type="text" v-model="savingsGoal" placeholder="Enter your target amount" />
                  </div>
                  <div class="form-group">
                    <label>Timeline</label>
                    <div class="timeline-group">
                      <input type="number" v-model="duration" placeholder="Duration" />
                      <select v-model="timeUnit">
                        <option value="weeks">Weeks</option>
                        <option value="months">Months</option>
                        <option value="years">Years</option>
                      </select>
                    </div>
                  </div>
                  <div class="form-group">
                    <label>Initial Deposit (Optional)</label>
                    <input type="text" v-model="initialDeposit" placeholder="Amount already saved" />
                  </div>
                  <div class="form-group">
                    <label>Interest Rate (Annual %)</label>
                    <input type="text" v-model="interestRate" placeholder="e.g. 5" />
                  </div>
                  <button class="calculate-savings-btn" @click="calculateSavings">Calculate Savings Plan</button>
                </div>
              </div>

              <!-- 右：结果 + 折线图 -->
              <div class="calculator-right">
                <div class="savings-plan-card">
                  <h3>Your Savings Plan</h3>
                  <div class="plan-box">
                    <div class="plan-amount">
                      <span class="currency">$</span>
                      <span class="amount">{{ formatNumber(monthlyAmount) }}</span>
                    </div>
                    <p class="plan-description">Required savings per month</p>
                  </div>
                  <div class="stat-pills">
                    <div class="stat-pill">
                      <div class="pill-amount blue">${{ formatNumber(weeklyAmount) }}</div>
                      <div class="pill-label">Per Week</div>
                    </div>
                    <div class="stat-pill">
                      <div class="pill-amount purple">${{ formatNumber(monthlyAmount) }}</div>
                      <div class="pill-label">Per Month</div>
                    </div>
                  </div>
                </div>

                <div class="chart-section">
                  <h4>Progress Visualization</h4>
                  <div ref="savingsChartRef" class="savings-chart"></div>
                </div>
              </div>
            </div><!-- /calculator-container -->
          </div><!-- /calculator-card -->
        </div><!-- /savings-calculator-section -->
      </div>
    </div>
  </div>
</template>

<script>
import { ref, onMounted, computed } from "vue";
import * as echarts from "echarts";

export default {
  name: "BudgetPlanner",
  setup() {
    /** ===== 左侧表单状态 ===== */
    const income = ref({ salary: "5800", investments: "0", other: "0" });
    const expenses = ref({
      housing: "1800",
      transportation: "650",
      food: "400",
      entertainment: "200",
      healthcare: "150",
    });

    /** ===== 右侧 Flashcards 索引（0: 图表 / 1: Alerts） ===== */
    const activeIndex = ref(0);
    const nextCard = () => (activeIndex.value = (activeIndex.value + 1) % 2);
    const prevCard = () => (activeIndex.value = (activeIndex.value + 1) % 2);

    /** ===== 饼图（Expense Distribution） ===== */
    const chartRef = ref(null);
    let chart = null;

    const initChart = () => {
      if (!chartRef.value) return;
      chart = echarts.init(chartRef.value);
      updateChart();
      window.addEventListener("resize", () => chart && chart.resize());
    };

    const updateChart = () => {
      if (!chart) return;
      const data = [
        { value: parseFloat(expenses.value.housing) || 0, name: "Housing" },
        { value: parseFloat(expenses.value.transportation) || 0, name: "Transportation" },
        { value: parseFloat(expenses.value.food) || 0, name: "Food & Dining" },
        { value: parseFloat(expenses.value.entertainment) || 0, name: "Entertainment" },
        { value: parseFloat(expenses.value.healthcare) || 0, name: "Healthcare" },
      ];
      chart.setOption({
        tooltip: { trigger: "item", formatter: "{b}<br/>${c} ({d}%)" },
        legend: { bottom: 8 },
        series: [
          {
            name: "Expenses",
            type: "pie",
            radius: ["40%", "70%"],
            center: ["50%", "50%"],
            itemStyle: { borderRadius: 8, borderColor: "#fff", borderWidth: 2 },
            label: { formatter: "{b}\n${c}" },
            data: data.length ? data : [{ value: 1, name: "No Data" }],
          },
        ],
      });
    };

    const calculateBudget = () => {
      // 计算后刷新图
      if (chart) updateChart();
    };

    /** ===== Alerts：Spent 来自左侧 expenses；Budget 可编辑 ===== */
    const categoryMeta = [
      { key: "housing",        name: "Housing" },
      { key: "transportation", name: "Transportation" },
      { key: "food",           name: "Food & Dining" },
      { key: "entertainment",  name: "Entertainment" },
      { key: "healthcare",     name: "Healthcare" },
    ];

    // 可编辑预算
    const budgets = ref({
      housing: 2000,
      transportation: 500,
      food: 600,
      entertainment: 300,
      healthcare: 200,
    });

    // 合成用于展示的卡片数据
    const alertCards = computed(() => {
      return categoryMeta.map((m) => {
        const spent  = parseFloat(expenses.value[m.key]) || 0;
        const budget = parseFloat(budgets.value[m.key]) || 0;
        return { ...m, spent, budget };
      });
    });

    const percentUsed = (item) => {
      const spent = item.spent || 0;
      const budget = item.budget || 0;
      if (budget <= 0) return spent > 0 ? 100 : 0;
      return Math.round((spent / budget) * 100);
    };
    const statusClass = (item) => {
      const p = percentUsed(item);
      if (p > 100) return "exceeded";
      if (p >= 90) return "warning";
      return "good";
    };
    const barClass = (item) => statusClass(item);
    const progressWidth = (item) => Math.min(percentUsed(item), 100) + "%";
    const statusText = (item) => {
      const p = percentUsed(item);
      if (p > 100) return "Exceeded";
      if (p >= 90) return "Warning";
      return "Good";
    };
    const statusIcon = (item) => {
      const p = percentUsed(item);
      return p > 100 ? "🚫" : p >= 90 ? "⚠️" : "✅";
    };
    const formatNumber = (v) => (parseFloat(v) || 0).toLocaleString();

    /** ===== 储蓄目标计算器 ===== */
    const savingsChartRef = ref(null);
    let savingsChart = null;

    const savingsGoal = ref("10000");
    const duration = ref("12");
    const timeUnit = ref("months");
    const initialDeposit = ref("1000");
    const interestRate = ref("5"); // 未参与计算，仅展示
    const monthlyAmount = ref("750");
    const weeklyAmount = ref("173");

    const initSavingsChart = () => {
      if (!savingsChartRef.value) return;
      savingsChart = echarts.init(savingsChartRef.value);
      updateSavingsChart();
      window.addEventListener("resize", () => savingsChart && savingsChart.resize());
    };

    const updateSavingsChart = () => {
      if (!savingsChart) return;
      const months = 12;
      const monthlyTarget = parseFloat(monthlyAmount.value) || 750;
      const initial = parseFloat(initialDeposit.value) || 1000;
      const data = Array.from({ length: months + 1 }, (_, i) => initial + monthlyTarget * i);

      savingsChart.setOption({
        grid: { left: "12%", right: "8%", top: "10%", bottom: "16%" },
        xAxis: {
          type: "category",
          data: Array.from({ length: months + 1 }, (_, i) => i.toString()),
          axisTick: { show: false },
          axisLine: { show: false },
          axisLabel: { color: "#666" },
        },
        yAxis: {
          type: "value",
          splitLine: { lineStyle: { color: "#f0f0f0" } },
          axisTick: { show: false },
          axisLine: { show: false },
          axisLabel: { color: "#666", formatter: (val) => "$" + (val / 1000).toFixed(0) + "k" },
        },
        series: [
          {
            data,
            type: "line",
            smooth: true,
            lineStyle: { color: "#16a34a", width: 3 },
            itemStyle: { color: "#16a34a" },
            symbol: "circle",
            symbolSize: 6,
            areaStyle: {
              color: {
                type: "linear",
                x: 0, y: 0, x2: 0, y2: 1,
                colorStops: [
                  { offset: 0, color: "rgba(22,163,74,.28)" },
                  { offset: 1, color: "rgba(22,163,74,.05)" },
                ],
              },
            },
          },
        ],
      });
    };

    const calculateSavings = () => {
      const goal = parseFloat(savingsGoal.value) || 0;
      const initial = parseFloat(initialDeposit.value) || 0;
      const remaining = Math.max(goal - initial, 0);

      let months = parseFloat(duration.value) || 1;
      if (timeUnit.value === "weeks") months = months / 4.33;
      if (timeUnit.value === "years") months = months * 12;

      const perMonth = remaining / months;
      const perWeek = remaining / (months * 4.33);

      monthlyAmount.value = Math.round(perMonth).toString();
      weeklyAmount.value = Math.round(perWeek).toString();

      updateSavingsChart();
    };

    /** ===== 挂载 ===== */
    onMounted(() => {
      // 初始化默认值展示
      initChart();
      calculateBudget();

      initSavingsChart();
      calculateSavings();
    });

    return {
      // 表单
      income, expenses, calculateBudget,
      // flashcards
      activeIndex, nextCard, prevCard,
      // 饼图
      chartRef,
      // alerts（联动 + 可编辑预算）
      budgets, alertCards, percentUsed, statusClass, barClass, progressWidth, statusText, statusIcon, formatNumber,
      // 储蓄计算器
      savingsGoal, duration, timeUnit, initialDeposit, interestRate, monthlyAmount, weeklyAmount,
      savingsChartRef, calculateSavings,
    };
  },
};
</script>

<style scoped>
.budget-planner { min-height: 100vh; background: #f8fafc; }
.main-content { padding: 3rem 0; }
.container { max-width: 1400px; margin: 0 auto; padding: 0 2rem; }

/* Grid: 左侧表单 + 右侧 Flashcards */
.budget-section { display: grid; grid-template-columns: 1fr 1fr; gap: 3rem; margin-bottom: 3rem; }

/* 左侧表单卡片 */
.form-section { background: #fff; padding: 2rem; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,.1); }
.income-section, .expenses-section { margin-bottom: 2rem; }

.section-header { display: flex; align-items: center; gap: .5rem; margin-bottom: 1rem; }
.section-icon { width: 12px; height: 12px; border-radius: 50%; }
.section-icon.green { background: #10B981; }
.section-icon.red { background: #EF4444; }
.section-header h3 { font-size: 1.1rem; font-weight: 700; color: #111827; margin: 0; }

.form-group { margin-bottom: 1rem; }
.form-group label { display: block; font-size: .875rem; font-weight: 500; color: #374151; margin-bottom: .5rem; }
.form-group input { width: 100%; padding: .75rem; border: 1px solid #d1d5db; border-radius: 8px; background: #fff; font-size: .9rem; }
.form-group input:focus { outline: none; border-color: #4F46E5; box-shadow: 0 0 0 3px rgba(79,70,229,.12); }

.calculate-btn { width: 100%; background: #4F46E5; color: #fff; border: 0; padding: .9rem; border-radius: 10px; font-weight: 700; cursor: pointer; }
.calculate-btn:hover { background: #4338CA; }

/* 右侧 Flashcard 容器 */
.summary-section { display: flex; flex-direction: column; gap: 1rem; }
.flashcard { background: #fff; border-radius: 12px; box-shadow: 0 8px 24px rgba(0,0,0,.06); padding: 1rem; }
.flashcard-header { display: flex; justify-content: space-between; align-items: center; padding: .25rem .25rem .75rem; border-bottom: 1px solid #f1f5f9; margin-bottom: .75rem; }
.flashcard-header h3 { font-size: 1.05rem; font-weight: 800; color: #111827; margin: 0; }
.nav { display: inline-flex; gap: .5rem; }
.nav-btn { width: 34px; height: 34px; border-radius: 8px; border: 1px solid #e5e7eb; background: #fff; font-size: 18px; line-height: 1; cursor: pointer; }
.nav-btn:hover { background: #f8fafc; }

/* Flashcard 内容（v-show） */
.flashcard-body { position: relative; min-height: 380px; }
.flashcard-body .pane { position: absolute; inset: 0; transition: opacity .25s ease; }
.flashcard-body .pane[style*="display: none"] { opacity: 0; pointer-events: none; }

/* 饼图卡片 */
.chart-section { background: #fff; padding: .25rem; border-radius: 12px; }
.summary-section .chart-container { height: 380px; min-height: 380px; }

/* Alerts 紧凑栅格 */
.alerts-intro .muted { color: #64748b; font-size: .9rem; margin: .25rem 0 .75rem; }
.alerts-grid.compact { display: grid; grid-template-columns: repeat(2,1fr); gap: .75rem; }
.alert-card { background: #fff; border-radius: 12px; padding: 1rem; box-shadow: 0 1px 3px rgba(0,0,0,.06); border-left: 4px solid; }
.alert-card.warning  { border-left-color: #F59E0B; }
.alert-card.exceeded { border-left-color: #EF4444; }
.alert-card.good     { border-left-color: #10B981; }

.alert-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: .5rem; }
.alert-header h4 { font-size: 1rem; font-weight: 700; color: #111827; margin: 0; }
.alert-content { display: flex; flex-direction: column; gap: .6rem; }
.alert-row { display: flex; justify-content: space-between; font-size: .875rem; color: #64748b; }

.progress-bar { width: 100%; height: 8px; background: #f1f5f9; border-radius: 4px; overflow: hidden; }
.progress-fill { height: 100%; border-radius: 4px; }
.progress-fill.warning  { background: #F59E0B; }
.progress-fill.exceeded { background: #EF4444; }
.progress-fill.good     { background: #10B981; }

.alert-status { font-size: .85rem; font-weight: 600; }
.alert-card.warning  .alert-status { color: #F59E0B; }
.alert-card.exceeded .alert-status { color: #EF4444; }
.alert-card.good     .alert-status { color: #10B981; }

/* 可编辑预算输入样式 */
.alert-row.editable { align-items: center; }
.budget-edit { display: inline-flex; align-items: center; gap: 6px; }
.budget-edit .currency { color: #6b7280; font-size: 0.9rem; }
.budget-input {
  width: 110px;
  padding: 6px 10px;
  border: 1px solid #e5e7eb;
  border-radius: 8px;
  font-size: 0.9rem;
  background: #fff;
}
.budget-input:focus {
  outline: none;
  border-color: #4F46E5;
  box-shadow: 0 0 0 3px rgba(79,70,229,.12);
}

/* ===== Savings Goal Calculator ===== */
.savings-calculator-section { margin-top: 3rem; }
.calc-header { text-align: center; margin-bottom: .75rem; }
.calc-header h2 { font-size: 1.5rem; font-weight: 800; color: #111827; }
.calc-header p  { margin-top: .25rem; color: #6b7280; font-size: .92rem; }

.calculator-card { background: #fff; border-radius: 14px; box-shadow: 0 12px 24px rgba(0,0,0,.08); padding: .75rem .75rem 1.25rem; }
.calculator-container { display: grid; grid-template-columns: 1fr 1fr; min-height: 560px; }

.calculator-left { padding: 1.5rem; }
.savings-calculator-section .calculator-left .form-section { background: #ffffff; border: 1px solid #e5e7eb; border-radius: 10px; box-shadow: none; padding: 1rem; }

.timeline-group { display: grid; grid-template-columns: 1fr auto; gap: .5rem; }
.timeline-group input, .timeline-group select { padding: .75rem; border: 1px solid #d1d5db; border-radius: 8px; font-size: .9rem; background: #fff; }
.timeline-group select { min-width: 100px; }

.calculate-savings-btn { width: 100%; background: #16a34a; color: #fff; border: 0; padding: .9rem; border-radius: 10px; font-weight: 700; cursor: pointer; margin-top: .75rem; }
.calculate-savings-btn:hover { background: #15803d; }

.calculator-right { padding: 1rem; }
.savings-plan-card { background: linear-gradient(180deg, #effaf3 0%, #f3fbf6 100%); border-radius: 10px; padding: 1rem; }
.savings-plan-card h3 { font-size: 1rem; font-weight: 700; color: #1f2937; margin-bottom: .75rem; }
.plan-box { background: #fff; border: 1px solid #e5e7eb; border-radius: 10px; padding: 1rem; }
.plan-amount .currency { color: #16a34a; font-weight: 700; }
.plan-amount .amount { color: #16a34a; font-size: 1.75rem; font-weight: 800; }
.plan-description { margin-top: .25rem; color: #6b7280; font-size: .85rem; }
.stat-pills { display: grid; grid-template-columns: 1fr 1fr; gap: .75rem; margin-top: .75rem; }
.stat-pill { background: #fff; border: 1px solid #e5e7eb; border-radius: 10px; padding: .75rem; text-align: center; }
.pill-amount { font-weight: 800; }
.pill-amount.blue { color: #2563eb; }
.pill-amount.purple { color: #7c3aed; }
.pill-label { font-size: .75rem; color: #6b7280; }

.chart-section h4 { font-size: .95rem; font-weight: 700; color: #1f2937; margin-bottom: .75rem; }
.savings-chart { width: 100%; height: 200px; background: #f8f9fa; border: 1px solid #e5e7eb; border-radius: 8px; }

/* 响应式 */
@media (max-width: 1024px) {
  .budget-section { grid-template-columns: 1fr; gap: 2rem; }
  .alerts-grid.compact { grid-template-columns: 1fr; }
}
@media (max-width: 768px) {
  .calculator-container { grid-template-columns: 1fr; }
}
</style>
